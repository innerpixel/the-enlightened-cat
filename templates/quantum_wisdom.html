{% extends "base.html" %}

{% block head %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500&display=swap" rel="stylesheet">
{% endblock %}

{% block title %}Quantum Whispurrs | The Enlightened Cat{% endblock %}

{% block content %}
<div class="wisdom-container">
    <h1>Quantum Whispurrs</h1>
    
    <div class="quantum-explanation">
        <p>Just like Schrödinger's famous cat, these wisdom nuggets exist in multiple states simultaneously until observed.</p>
        <p>The Enlightened Cat's quantum whispers hover in a state of purr-adoxical superposition below. Hover over each blurry state to bring it into focus, then click on one to collapse the quantum wave function.</p>
        <p><em>"In the quantum realm, a cat may be both wise and playful until you look at it."</em></p>
    </div>
    
    <div id="quantum-states-container" class="quantum-states">
        <div class="loading-spinner">Loading quantum states...</div>
    </div>
    
    <!-- Observe button removed for more mysterious interaction -->
    
    <div id="collapsed-state-container" class="collapsed-state hidden">
        <h2>Observed Wisdom</h2>
        <p id="collapsed-wisdom"></p>
        <div id="quantum-story-container" class="hidden">
            <h3>Quantum Tale</h3>
            <p id="quantum-story" class="quantum-story"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const statesContainer = document.getElementById('quantum-states-container');
    const collapsedContainer = document.getElementById('collapsed-state-container');
    const collapsedWisdom = document.getElementById('collapsed-wisdom');
    const quantumPage = document.querySelector('.quantum-page');
    let selectedState = null;
    let observationInProgress = false;
    let statesLoaded = false;
    
    // Fetch quantum wisdom in superposition
    fetch('/api/quantum-wisdom')
        .then(response => response.json())
        .then(data => {
            statesContainer.innerHTML = '';
            
            // Display all potential states
            data.quantum_wisdom.potential_states.forEach((state, index) => {
                const stateElement = document.createElement('div');
                stateElement.className = 'quantum-state';
                stateElement.innerHTML = `
                    <div class="state-content">${state}</div>
                `;
                
                // Make each quantum state clickable
                stateElement.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent the document click from firing
                    if (!observationInProgress) {
                        // Mark this state as selected
                        if (selectedState) {
                            selectedState.classList.remove('selected');
                        }
                        selectedState = stateElement;
                        stateElement.classList.add('selected');
                        
                        // Automatically trigger observation after a short delay
                        setTimeout(() => observeQuantumState(stateElement), 300);
                    }
                });
                
                statesContainer.appendChild(stateElement);
            });
            
            // Add a subtle floating animation to each state with random delays
            document.querySelectorAll('.quantum-state').forEach(state => {
                state.style.animationDelay = `${Math.random() * 2}s`;
                state.classList.add('floating');
            });
            
            // If wisdom is already observed, show the collapsed state
            if (data.quantum_wisdom.observed && data.quantum_wisdom.collapsed_state) {
                collapsedWisdom.textContent = data.quantum_wisdom.collapsed_state;
                collapsedContainer.classList.remove('hidden');
                statesContainer.classList.add('collapsing');
                observationInProgress = true;
            } else {
                statesLoaded = true;
            }
        })
        .catch(error => {
            statesContainer.innerHTML = `<div class="error">Error loading quantum states: ${error}</div>`;
        });
    
    // Function to observe quantum state
    function observeQuantumState(clickedElement = null) {
        if (observationInProgress) return;
        
        observationInProgress = true;
        
        // Add observed class to all states
        document.querySelectorAll('.quantum-state').forEach(state => {
            if (state !== clickedElement) {
                state.classList.add('observed');
            }
        });
        
        // Determine which state to observe and its index
        let stateIndex = null;
        let selectedWisdom = null;
        
        // If a state was clicked, make it the chosen one
        if (clickedElement) {
            clickedElement.classList.add('chosen');
            // Find the index of the clicked element
            const states = Array.from(document.querySelectorAll('.quantum-state'));
            stateIndex = states.indexOf(clickedElement);
            // Store the content of the selected wisdom
            selectedWisdom = clickedElement.querySelector('.state-content').textContent.trim();
            console.log('Selected wisdom:', selectedWisdom);
        } else {
            // If no specific state was clicked, randomly choose one
            const states = document.querySelectorAll('.quantum-state');
            if (states.length > 0) {
                const randomIndex = Math.floor(Math.random() * states.length);
                states[randomIndex].classList.add('chosen');
                stateIndex = randomIndex;
                // Store the content of the randomly selected wisdom
                selectedWisdom = states[randomIndex].querySelector('.state-content').textContent.trim();
                console.log('Randomly selected wisdom:', selectedWisdom);
            }
        }
        
        // Construct the URL with the state index if we have one
        const observeUrl = stateIndex !== null ? 
            `/api/quantum-wisdom/observe?state_index=${stateIndex}` : 
            '/api/quantum-wisdom/observe';
        
        fetch(observeUrl)
            .then(response => response.json())
            .then(data => {
                // Show the collapsed state after a delay to allow animations to complete
                setTimeout(() => {
                    // Verify if the server returned the correct wisdom
                    const returnedWisdom = data.quantum_wisdom.collapsed_state;
                    console.log('Server returned wisdom:', returnedWisdom);
                    
                    // If we have a selected wisdom and it doesn't match what the server returned,
                    // use our selected wisdom instead (this ensures consistency)
                    if (selectedWisdom && returnedWisdom !== selectedWisdom) {
                        console.log('Mismatch detected, using selected wisdom instead');
                        collapsedWisdom.textContent = selectedWisdom;
                    } else {
                        collapsedWisdom.textContent = returnedWisdom;
                    }
                    
                    collapsedContainer.classList.remove('hidden');
                    
                    // Add animation classes
                    collapsedContainer.classList.add('appearing');
                    
                    // Generate a quantum story based on the observed wisdom
                    // Use the wisdom we're actually displaying
                    generateQuantumStory(collapsedWisdom.textContent);
                }, 500);
            })
            .catch(error => {
                collapsedWisdom.textContent = `Error observing quantum state: ${error}`;
                collapsedContainer.classList.remove('hidden');
            });
    }
    
    // Function to generate a quantum story based on the observed wisdom
    function generateQuantumStory(wisdom) {
        const storyContainer = document.getElementById('quantum-story-container');
        const storyElement = document.getElementById('quantum-story');
        
        // Show loading indicator
        storyElement.textContent = 'The quantum cat is weaving a tale...';
        storyContainer.classList.remove('hidden');
        
        // In a real implementation, this would call an API endpoint
        // For now, we'll generate a simple story based on the wisdom
        setTimeout(() => {
            const catNames = ['Quantum', 'Schrödinger', 'Heisenberg', 'Planck', 'Einstein'];
            const randomCat = catNames[Math.floor(Math.random() * catNames.length)];
            
            const storyIntros = [
                `In a parallel universe where cats rule the quantum realm, ${randomCat} the cat sat contemplating:`,
                `${randomCat}, the enlightened feline, purred softly as it shared this wisdom with its human:`,
                `As ${randomCat} walked through multiple dimensions simultaneously, a profound realization emerged:`,
                `The quantum cat named ${randomCat} existed in many states at once, but in all of them it knew that:`,
                `${randomCat} the cat, both present and not present, whispered across the multiverse:`
            ];
            
            const storyConclusions = [
                `And with that insight, reality itself seemed to purr in contentment.`,
                `The human nodded, not fully comprehending, but feeling strangely at peace.`,
                `Somewhere in the multiverse, another version of you is reading this same wisdom, but interpreting it differently.`,
                `${randomCat} then vanished, leaving behind only quantum paw prints and this lingering thought.`,
                `This wisdom exists in all possible universes, but only in this one did you choose to observe it.`
            ];
            
            const randomIntro = storyIntros[Math.floor(Math.random() * storyIntros.length)];
            const randomConclusion = storyConclusions[Math.floor(Math.random() * storyConclusions.length)];
            
            const story = `${randomIntro} "${wisdom}" ${randomConclusion}`;
            
            storyElement.textContent = story;
            storyElement.classList.add('story-revealed');
        }, 2000);
    }
    
    // Add click event to the document for random observation
    document.addEventListener('click', function(e) {
        // Only trigger if we're not clicking on a quantum state or the collapsed container
        // and if states are loaded and not already observed
        if (statesLoaded && !observationInProgress && 
            !e.target.closest('.quantum-state') && 
            !e.target.closest('#collapsed-state-container')) {
            observeQuantumState();
        }
    });
});
</script>
{% endblock %}
